# IPTV WebExtension æ’­æ”¾å™¨äº§å“è®¾è®¡æ–‡æ¡£

## 1. äº§å“æ¦‚è¿°

### 1.1 äº§å“å®šä½
ä¸€æ¬¾è½»é‡çº§çš„æµè§ˆå™¨æ‰©å±•ï¼Œç”¨äºå¯¼å…¥ M3U æ’­æ”¾åˆ—è¡¨å¹¶æ’­æ”¾ M3U8 ç›´æ’­æµï¼Œå…¼å®¹ Chrome/Edge æµè§ˆå™¨ã€‚

### 1.2 æ ¸å¿ƒåŠŸèƒ½
- M3U æ–‡ä»¶å¯¼å…¥ï¼ˆæ”¯æŒæ‹–æ‹½å’Œæ–‡ä»¶é€‰æ‹©ï¼‰
- M3U8 æµåª’ä½“æ’­æ”¾
- é¢‘é“åˆ—è¡¨ç®¡ç†ä¸æœç´¢
- æ’­æ”¾å†å²è®°å½•

### 1.3 æŠ€æœ¯åŸåˆ™
- ä½¿ç”¨ Vanilla JavaScriptï¼Œæ— æ¡†æ¶ä¾èµ–
- æœ€å°åŒ–ç¬¬ä¸‰æ–¹åº“ï¼ˆä»… HLS.js ç”¨äº M3U8 æ’­æ”¾ï¼‰
- éµå¾ª Manifest V3 è§„èŒƒ

---

## 2. æ¶æ„è®¾è®¡

### 2.1 ç›®å½•ç»“æ„
```
iptvWebExt/
â”œâ”€â”€ manifest.json              # æ‰©å±•é…ç½®æ–‡ä»¶
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ background/           # åå°æœåŠ¡
â”‚   â”‚   â””â”€â”€ service-worker.js
â”‚   â”œâ”€â”€ popup/               # å¼¹å‡ºçª—å£
â”‚   â”‚   â”œâ”€â”€ popup.html
â”‚   â”‚   â”œâ”€â”€ popup.css
â”‚   â”‚   â””â”€â”€ popup.js
â”‚   â”œâ”€â”€ options/             # è®¾ç½®é¡µé¢
â”‚   â”‚   â”œâ”€â”€ options.html
â”‚   â”‚   â”œâ”€â”€ options.css
â”‚   â”‚   â””â”€â”€ options.js
â”‚   â”œâ”€â”€ player/              # æ’­æ”¾å™¨é¡µé¢
â”‚   â”‚   â”œâ”€â”€ player.html
â”‚   â”‚   â”œâ”€â”€ player.css
â”‚   â”‚   â””â”€â”€ player.js
â”‚   â””â”€â”€ shared/              # å…±äº«æ¨¡å—
â”‚       â”œâ”€â”€ storage.js       # å­˜å‚¨ç®¡ç†
â”‚       â”œâ”€â”€ m3u-parser.js   # M3U è§£æå™¨
â”‚       â””â”€â”€ constants.js     # å¸¸é‡å®šä¹‰
â”œâ”€â”€ lib/                     # ç¬¬ä¸‰æ–¹åº“
â”‚   â””â”€â”€ hls.min.js          # HLS.js (ç”¨äº m3u8 æ’­æ”¾)
â””â”€â”€ icons/                   # å›¾æ ‡èµ„æº
    â”œâ”€â”€ icon16.png
    â”œâ”€â”€ icon48.png
    â””â”€â”€ icon128.png
```

### 2.2 æŠ€æœ¯æ ˆ

| ç±»åˆ« | æŠ€æœ¯é€‰å‹ | è¯´æ˜ |
|------|---------|------|
| æ‰©å±•è§„èŒƒ | Manifest V3 | Chrome/Edge æœ€æ–°æ ‡å‡† |
| å‰ç«¯è¯­è¨€ | Vanilla JavaScript ES6+ | æ— æ¡†æ¶ä¾èµ– |
| æ ·å¼ | CSS3 | ä½¿ç”¨ CSS Grid/Flexbox |
| å­˜å‚¨ | chrome.storage.local | æŒä¹…åŒ–é¢‘é“åˆ—è¡¨å’Œé…ç½® |
| æ’­æ”¾å™¨ | HTML5 Video + HLS.js | M3U8 æµåª’ä½“æ”¯æŒ |

---

## 3. åŠŸèƒ½æ¨¡å—è®¾è®¡

### 3.1 M3U è§£æå™¨ (m3u-parser.js)

**èŒè´£**: è§£æ M3U æ–‡ä»¶ï¼Œæå–é¢‘é“ä¿¡æ¯

**æ ¸å¿ƒåŠŸèƒ½**:
```javascript
/**
 * è§£æ M3U æ–‡ä»¶å†…å®¹
 * @param {string} content - M3U æ–‡ä»¶å†…å®¹
 * @returns {Array<Channel>} é¢‘é“åˆ—è¡¨
 */
function parseM3U(content)

/**
 * é¢‘é“æ•°æ®ç»“æ„
 * {
 *   id: string,           // å”¯ä¸€æ ‡è¯†
 *   name: string,         // é¢‘é“åç§°
 *   logo: string,         // å°æ ‡ URL
 *   group: string,        // åˆ†ç»„
 *   url: string,          // æµåœ°å€
 *   tvgId?: string,       // EPG ID
 *   tvgName?: string,     // EPG åç§°
 * }
 */
```

**æ”¯æŒæ ¼å¼**:
- æ ‡å‡† M3U æ ¼å¼ (`#EXTINF`)
- tvg-id, tvg-name, tvg-logo å±æ€§
- group-title åˆ†ç»„

---

### 3.2 å­˜å‚¨ç®¡ç† (storage.js)

**èŒè´£**: å°è£… chrome.storage APIï¼Œæä¾›æ•°æ®æŒä¹…åŒ–

**æ ¸å¿ƒæ¥å£**:
```javascript
// é¢‘é“åˆ—è¡¨ç®¡ç†
async saveChannels(channels: Channel[]): Promise<void>
async getChannels(): Promise<Channel[]>
async addChannel(channel: Channel): Promise<void>
async removeChannel(channelId: string): Promise<void>
async updateChannel(channelId: string, updates: Partial<Channel>): Promise<void>

// æ’­æ”¾å†å²
async addHistory(channel: Channel): Promise<void>
async getHistory(): Promise<Channel[]>
async clearHistory(): Promise<void>

// ç”¨æˆ·é…ç½®
async saveSettings(settings: Settings): Promise<void>
async getSettings(): Promise<Settings>

/**
 * è®¾ç½®æ•°æ®ç»“æ„
 * {
 *   defaultQuality: string,    // é»˜è®¤ç”»è´¨
 *   autoPlay: boolean,         // è‡ªåŠ¨æ’­æ”¾
 *   volume: number,            // éŸ³é‡ (0-100)
 * }
 */
```

---

### 3.3 å¼¹å‡ºçª—å£ (Popup)

**æ–‡ä»¶**: `src/popup/`

**åŠŸèƒ½**: å¿«é€Ÿè®¿é—®é¢‘é“åˆ—è¡¨å’Œå¯åŠ¨æ’­æ”¾å™¨

**UI å¸ƒå±€**:
```
+----------------------------------+
| IPTV Player           [âš™] [?]   |
+----------------------------------+
| [ğŸ” æœç´¢é¢‘é“...]                  |
+----------------------------------+
| ğŸ“º å¤®è§†é¢‘é“                      |
|   CCTV-1                         |
|   CCTV-2                         |
|                                  |
| ğŸ“º å«è§†é¢‘é“                      |
|   æ¹–å—å«è§†                       |
|   æµ™æ±Ÿå«è§†                       |
|                                  |
| ğŸ“º åœ°æ–¹å°                        |
|   ...                            |
+----------------------------------+
| [ğŸ“ å¯¼å…¥ M3U]  [ğŸ•’ å†å²]         |
+----------------------------------+
```

**äº¤äº’æµç¨‹**:
1. ç‚¹å‡»é¢‘é“ â†’ åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€æ’­æ”¾å™¨
2. ç‚¹å‡»å¯¼å…¥ â†’ æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨
3. ç‚¹å‡»å†å² â†’ æ˜¾ç¤ºæ’­æ”¾å†å²åˆ—è¡¨

---

### 3.4 æ’­æ”¾å™¨é¡µé¢ (Player)

**æ–‡ä»¶**: `src/player/`

**åŠŸèƒ½**: å…¨å±æ’­æ”¾ M3U8 æµåª’ä½“

**UI å¸ƒå±€**:
```
+----------------------------------+
| â† è¿”å›    CCTV-1 é«˜æ¸…  [ğŸ“„]     |
+----------------------------------+
|                                  |
|                                  |
|        [ Video Player ]          |
|                                  |
|                                  |
+----------------------------------+
| â–¶ï¸  â¸  ğŸ”Š  ğŸ”‡  ğŸ“º  â›¶PIPSU        |
+----------------------------------+
| é¢‘é“åˆ—è¡¨: [ğŸ“‹]                    |
| Related:                          |
|   CCTV-2  CCTV-3  CCTV-4          |
+----------------------------------+
```

**æ ¸å¿ƒåŠŸèƒ½**:
- HLS.js é›†æˆæ’­æ”¾
- ç”»ä¸­ç”»æ¨¡å¼
- é”®ç›˜å¿«æ·é”®ï¼ˆç©ºæ ¼æš‚åœã€æ–¹å‘é”®åˆ‡æ¢é¢‘é“ï¼‰
- æ’­æ”¾é”™è¯¯é‡è¯•æœºåˆ¶
- é¢‘é“å¿«é€Ÿåˆ‡æ¢ä¾§è¾¹æ 

---

### 3.5 è®¾ç½®é¡µé¢ (Options)

**æ–‡ä»¶**: `src/options/`

**åŠŸèƒ½**: ç®¡ç†å¯¼å…¥çš„é¢‘é“åˆ—è¡¨å’Œé…ç½®

**UI å¸ƒå±€**:
```
+----------------------------------+
| è®¾ç½®                      |
+----------------------------------+
| Tabs: [é¢‘é“ç®¡ç†] [æ’­æ”¾è®¾ç½®] [å…³äº] |
+----------------------------------+
| é¢‘é“ç®¡ç†                         |
| æ€»è®¡: 128 ä¸ªé¢‘é“                 |
| [ğŸ“ å¯¼å…¥ M3U æ–‡ä»¶] [ğŸ—‘ï¸ æ¸…ç©º]     |
|                                  |
| +----------+--------------------+-+
| | é¢‘é“å   | URL                | |
| +----------+--------------------+-+
| | CCTV-1   | http://...         | âœ• |
| | CCTV-2   | http://...         | âœ• |
| +----------+--------------------+-+
| [æœç´¢...]                       |
+----------------------------------+
```

---

## 4. æ•°æ®æµè®¾è®¡

### 4.1 M3U å¯¼å…¥æµç¨‹

```mermaid
graph LR
    A[ç”¨æˆ·é€‰æ‹© M3U æ–‡ä»¶] --> B[FileReader è¯»å–]
    B --> C[m3uParser.parseM3U]
    C --> D[å»é‡å¤„ç†]
    D --> E[storage.saveChannels]
    E --> F[æ›´æ–° Popup æ˜¾ç¤º]
```

### 4.2 æ’­æ”¾æµç¨‹

```mermaid
graph LR
    A[ç”¨æˆ·ç‚¹å‡»é¢‘é“] --> B[æ‰“å¼€ player.html]
    B --> C[ä» URL å‚æ•°è·å–é¢‘é“ID]
    C --> D[storage.getChannels]
    D --> E[åˆå§‹åŒ– HLS.js]
    E --> F[åŠ è½½æµ]
    F --> G[storage.addHistory]
```

---

## 5. æƒé™ç”³è¯·

```json
{
  "permissions": [
    "storage"          // æ•°æ®å­˜å‚¨
  ],
  "host_permissions": [
    "*://*/*"          // å…è®¸åŠ è½½æ‰€æœ‰åŸŸåçš„ m3u8 æµ
  ]
}
```

---

## 6. ç¬¬ä¸‰æ–¹ä¾èµ–

### 6.1 HLS.js
- **ç‰ˆæœ¬**: ^1.4.0
- **ç”¨é€”**: åœ¨é Safari æµè§ˆå™¨æ’­æ”¾ M3U8
- **CDN**: `https://cdn.jsdelivr.net/npm/hls.js@latest/dist/hls.min.js`
- **å¤§å°**: ~300KB (minified)

### 6.2 ä¾èµ–è¯´æ˜
ä»…ä½¿ç”¨ HLS.js ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œå…¶ä½™å…¨éƒ¨ä½¿ç”¨åŸç”Ÿ Web APIã€‚

---

## 7. æµè§ˆå™¨å…¼å®¹æ€§

| æµè§ˆå™¨ | æœ€ä½ç‰ˆæœ¬ | å¤‡æ³¨ |
|--------|---------|------|
| Chrome | 88+ | Manifest V3 æ”¯æŒ |
| Edge | 88+ | Chromium å†…æ ¸ |
| Firefox | ä¸æ”¯æŒ | éœ€è¦å¦è¡Œé€‚é… |
| Safari | ä¸æ”¯æŒ | åŸç”Ÿæ”¯æŒ HLSï¼Œä½†æ‰©å±• API ä¸åŒ |

---

## 8. å®‰å…¨è€ƒè™‘

### 8.1 å†…å®¹å®‰å…¨ç­–ç•¥ (CSP)
```json
"content_security_policy": {
  "extension_pages": "script-src 'self'; object-src 'self'"
}
```

### 8.2 æ•°æ®éªŒè¯
- M3U URL æ ¼å¼éªŒè¯
- XSS é˜²æŠ¤ï¼ˆé¢‘é“åç§°è½¬ä¹‰ï¼‰
- å­˜å‚¨æ•°æ®å¤§å°é™åˆ¶ï¼ˆchrome.storage.local é™åˆ¶ 10MBï¼‰

---

## 9. æ€§èƒ½ä¼˜åŒ–

### 9.1 åˆ—è¡¨è™šæ‹ŸåŒ–
é¢‘é“åˆ—è¡¨è¶…è¿‡ 100 æ¡æ—¶ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨

### 9.2 å»¶è¿ŸåŠ è½½
HLS.js æŒ‰éœ€åŠ è½½ï¼Œä»…åœ¨æ’­æ”¾å™¨é¡µé¢å¼•å…¥

### 9.3 å›¾ç‰‡æ‡’åŠ è½½
é¢‘é“å°æ ‡ä½¿ç”¨ Intersection Observer å»¶è¿ŸåŠ è½½

---

## 10. åç»­æ‰©å±•æ–¹å‘

### 10.1 çŸ­æœŸè®¡åˆ’
- [ ] EPG ç”µå­èŠ‚ç›®å•æ”¯æŒ
- [ ] æ”¶è—å¤¹åŠŸèƒ½
- [ ] é¢‘é“åˆ†ç»„æŠ˜å 

### 10.2 é•¿æœŸè®¡åˆ’
- [ ] å¤šè¯­è¨€æ”¯æŒ
- [ ] è‡ªå®šä¹‰ä¸»é¢˜
- [ ] é¥æ§å™¨å¿«æ·é”®æ”¯æŒ
- [ ] Firefox é€‚é…

---

## 11. å¼€å‘é‡Œç¨‹ç¢‘

| é˜¶æ®µ | ç›®æ ‡ | äº¤ä»˜ç‰© |
|------|------|--------|
| Phase 1 | åŸºç¡€æ’­æ”¾ | M3U è§£æã€HLS æ’­æ”¾ |
| Phase 2 | ç®¡ç†åŠŸèƒ½ | è®¾ç½®é¡µé¢ã€é¢‘é“ç®¡ç† |
| Phase 3 | ä½“éªŒä¼˜åŒ– | æœç´¢ã€å†å²ã€å¿«æ·é”® |
| Phase 4 | å‘å¸ƒ | å•†åº—å®¡æ ¸ä¸Šæ¶ |

---

## é™„å½•

### A. M3U æ–‡ä»¶ç¤ºä¾‹
```m3u
#EXTM3U
#EXTINF:-1 tvg-id="CCTV1" tvg-name="CCTV1" tvg-logo="http://example.com/cctv1.png" group-title="å¤®è§†",CCTV-1
http://example.com/live/cctv1.m3u8
#EXTINF:-1 tvg-id="CCTV2" tvg-name="CCTV2" tvg-logo="http://example.com/cctv2.png" group-title="å¤®è§†",CCTV-2
http://example.com/live/cctv2.m3u8
```

### B. å‚è€ƒèµ„æº
- [Chrome Extension Manifest V3](https://developer.chrome.com/docs/extensions/mv3/)
- [HLS.js Documentation](https://github.com/video-dev/hls.js/)
- [M3U File Format](https://en.wikipedia.org/wiki/M3U)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2026-02-24
**ç»´æŠ¤è€…**: IPTV WebExtension Team
